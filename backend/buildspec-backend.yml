version: 0.2

env:
  parameter-store:
    AWS_REGION: "/backend/blog/aws-region"
    LAMBDA_FUNCTION_NAME: "/backend/blog/lambda-function-name"
    BLOG_TABLE_NAME: "/backend/blog/blog-table-name"
    LEADS_TOPIC_ARN: "/backend/blog/leads-topic-arn"
    MEDIA_BUCKET: "blog-crm-media"
    MEDIA_BASE_URL: "/backend/blog/media-bucket-base-url"
    MEDIA_PREFIX: "/backend/blog/media-prefix"
    FRONTEND_ORIGIN: "/blog/frontend/api-base-url"


phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - echo "Backend install phase (Lambda), CWD:$(pwd)"
      - cd backend
      - if [ -f package-lock.json ]; then npm ci; else npm install; fi
      - cd ..

  pre_build:
    commands:
      - echo "Running backend tests (if any)..."
      - cd backend
      - npm test || echo "No tests configured, skipping"
      - cd ..

  build:
    commands:
      - echo "Packaging backend for Lambda..."
      - cd backend
      - zip -r ../backend-lambda.zip . -x "node_modules/aws-sdk/*"
      - cd ..

  post_build:
    commands:
      - echo "Updating Lambda function. Name:'$LAMBDA_FUNCTION_NAME' Region:'$AWS_REGION'"
      - aws lambda update-function-code --function-name "$LAMBDA_FUNCTION_NAME" --zip-file fileb://backend-lambda.zip --region "$AWS_REGION"
      - echo "Lambda code update complete."


artifacts:
  files:
    - backend-lambda.zip
